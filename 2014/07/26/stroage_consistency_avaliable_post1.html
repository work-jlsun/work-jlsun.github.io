<a id="rocket" href="#top" class="show"></a><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title> 存储系统一致性与可用性 | Tom Talk</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden"> 存储系统一致性与可用性</h1><a id="logo" href="/">Tom Talk</a><p class="description">分享我的实践、思考、积累</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title"> 存储系统一致性与可用性</h1><div class="post-meta">2014-07-26 | </div><span data-disqus-identifier="/2014/07/26/stroage_consistency_avaliable_post1.html" class="disqus-comment-count"></span><div class="post-content"><h3 id="1-_关于可用性">1. 关于可用性</h3><p>提供系统可用性的关键是在相关组件失效情况下，系统能多快恢复并继续正确得提供服务。</p>
<h4 id="1-1_如何恢复服务">1.1 如何恢复服务</h4><p>How to recover a single node from power failure。</p>
<ul>
<li>wait for reboot</li>
</ul>
<p>Data is durable, but service is unavailable temporarily。</p>
<ul>
<li>Use multiple nodes to provide service</li>
</ul>
<p>Another node takes over to provide service, How to make sure nodes respond in the same way?</p>
<p>对于无状态的服务器而言，没有关系。对于有状态的服务器而言,如何去保证 take over的服务器提供正确的服务?</p>
<h3 id="1-2_两种基本方法">1.2 两种基本方法</h3><ul>
<li>多副本</li>
<li>纠删码<br>纠删码基本原理是把一份数据分割成多份，计算出若干冗余块，比如 切割成26份数据再使用纠删算法计算4份冗余块，可以使得任意丢4块数据还能恢复数据进行服务，核心还是通过数据冗余来实现一定的高可用。以下内容只针对简单多副本展开讨论，本文不对纠删码进行详述。</li>
</ul>
<p>对于简单多副本要保证多个副本的状态是一致的，才能保证另一个副本对应服务器能提供正确的服务。如何实现多副本之间的一致性?以下讨论相关理论及实现.</p>
<h2 id="2-_理论">2. 理论</h2><p>实现多副本一致的一个基本理论为 replicated stat machine，即副本状态机：副本所处的初始状态相同；每个副本执行的操作顺序相同，并且每一个操作都相同； 那么最终所有副本的状态是一致。</p>
<p><img src="/media/files/2014/07/OPaOPb.png" alt="OpaaOPb"></p>
<p>那如何保证在多个 client 并发操作下的保证操作的顺序性？以下分析 primary-backup协议，Qurom，paoxs 协议等协议</p>
<h3 id="2-1_Master_Slave">2.1 Master Slave</h3><p>Master / Slave 相对来讲是较简单和自然而然的方式，Master 决定操作的顺序，Slave 节点执行序列化之后的操作。</p>
<p><img src="/media/files/2014/07/Primary.png" alt="Primary.png"></p>
<p>Master Slave 协议较为简单， 但是其可用性不是很高， 在其中某一个节点宕机的情况下，系统无法继续运行。</p>
<p>如下图所示，在 state0 状态 Master 与 Slave 的 LSN(log sequence number)为 10，处于一致的状态，在 state1 时 Slave 发生宕机，Master 继续接受写请求，到 state2 时 Master 也生宕机，在 state3 时 Slave 恢复，但是 Master 与 Slave 的状态不一致，所以 Slave 即不能提供读也不能提供写， 此时即发生阻塞。 若想继续提供服务， 必须进行人工干预。 Master/slaver<br>协议是一种阻塞式的协议。 （数据库中的 “两阶段提交协议” 就是一种典型的阻塞式的协议）</p>
<p><img src="/media/files/2014/07/3.png" alt="3.png"></p>
<h3 id="2-2_Quroum/(NRW)">2.2  Quroum/(NRW)</h3><p>Quorum 机制是一种简单有效的副本管理机制。NWR 协议是其中的典型，NWR 为Amazon 公司设计的分布式 kv 系统 dynamo 中使用的分布式副本协议。</p>
<p>其中 N 为副本的数目， W 是写成功需要写的份数， R 为读成功需要读的份数， 保证 R+W&gt;N，即能读到正确的数据。</p>
<p>假设 N=3，W=1，R=3，即如果副本数目为 3，写 1 份即算成功，那么至少读 3 份才能读到写入的数据。 并且为了防止写丢失， 还必须用 “last write wins” 的方式解决写冲突问题。</p>
<p>NRW 可能出现数据丢失情况</p>
<p>如下图 所示， 例如用户先调用 OP1 写数据 obj1 的 A 副本成功返回， 然后用户调用 OP2写数据 obj1 的副本 C 成功后返回，此时使用”last write wins”的进行合并使得最终副本 A 和C 上的数据完全一致。但是如果 A 与 B 上的时钟不一致，比如 A 的时钟比 C 快，那么在数据整合的时候会出现先写的数据副本 A 上的操作覆盖后写的数据 C， 导致后写的 OP2 丢失，这显然不是用户想看到的信息。所以系统必须排除这种状况才能保证数据的最终一致性， 否则就是弱一致性。</p>
<p><img src="/media/files/2014/07/qurom.png" alt="qurom.png"></p>
<p>时钟同步：在分布式系统中本身就是很难事件的东西。</p>
<p>结论:NRW 其实也只是看上去很美的东西。但是 dynamo 为了使得系统能够有更好的可扩展性及可用性， 放宽对一致性的要求， 不支持强一致性， 而支持最终一致性甚至是弱一致性。 （弱一致性估计是很难使用户接受）</p>
<h3 id="2-3_paxos协议">2.3 paxos协议</h3><p>paxos 协议中每个节点都是对等的，每个节点都可以接收客户端的写请求，并尝试完成客户端的写请求，其核心是基于一个多数派的抢占机制式协议。</p>
<p><img src="/media/files/2014/07/basicPaxos.png" alt="basicPaxos.png"></p>
<h3 id="2-4_关于CAP">2.4 关于CAP</h3><p>各种分布式协议所面临的问题就是分布式文件系统的三大难题:副本一致性，系统可用性，分区容忍性（网络异常的容忍能力）。</p>
<p>CAP理论明确提出了不要妄图设计一种对 CAP 三大属性都完全拥有的系统，因为这种系统在理论上就已经被证明不存在。设计系统的时候需要在 C、A、P 这三方面有所折中。</p>
<p>Primary/backup：MySQL：具有完全的 C，很糟糕的 A，很糟糕的 P， （任何一个节点宕机都会导致服务中断）<br>Quroum 协议：Dynamo/cassandra，有一定的 C，有较好的 A，也有较好的 P，是一种较为平衡的分布式协议。<br>Paxos 协议：Spanner , Chubbuy, Zookeeper, megastore 具有完全的 C，较好的 A， 较好的 P。<br>发现很多开源系统在高可用、性能、可扩展性等很多方面没有一个完善的方案。希望设计一个 k/v 存储系统，系统支持强一致性，并且在 C，A，P 这三方面都较为均衡，系统具有一定可扩展性，详见下文。</p>
</div><div class="tags"><a href="/tags/avaliable/">avaliable</a><a href="/tags/consistency/">consistency</a><a href="/tags/storage/">storage</a></div><div class="post-nav"><a href="/2014/08/12/stroage_consistency_avaliable_post2.html" class="pre"><i class="icon-previous"> 存储系统一致性与可用性（二）</i></a><a href="/2014/01/20/golang-vs-nginx-test.html" class="next">Nginx And Go Http 并发性能<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'httpworkjlsungithubio';
var disqus_identifier = '/2014/07/26/stroage_consistency_avaliable_post1.html';
var disqus_title = ' 存储系统一致性与可用性';
var disqus_url = 'http://yoursite.com//2014/07/26/stroage_consistency_avaliable_post1.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//httpworkjlsungithubio.disqus.com/count.js" async="async"></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/浪漫/" style="font-size: 15px;">浪漫</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/从优秀到卓越/" style="font-size: 15px;">从优秀到卓越</a> <a href="/tags/阅读/" style="font-size: 15px;">阅读</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/Pragraming-Languages/" style="font-size: 15px;">Pragraming Languages</a> <a href="/tags/HTTP-API/" style="font-size: 15px;">HTTP API</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Murphy-s-law/" style="font-size: 15px;">Murphy's law</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/Tunning/" style="font-size: 15px;">Tunning</a> <a href="/tags/古典/" style="font-size: 15px;">古典</a> <a href="/tags/云存储/" style="font-size: 15px;">云存储</a> <a href="/tags/CDN/" style="font-size: 15px;">CDN</a> <a href="/tags/交流/" style="font-size: 15px;">交流</a> <a href="/tags/云存储、cdn/" style="font-size: 15px;">云存储、cdn</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/performance/" style="font-size: 15px;">performance</a> <a href="/tags/goroutine/" style="font-size: 15px;">goroutine</a> <a href="/tags/storage/" style="font-size: 15px;">storage</a> <a href="/tags/consistency/" style="font-size: 15px;">consistency</a> <a href="/tags/avaliable/" style="font-size: 15px;">avaliable</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/tunning-nginx-performance.html">Nginx 性能调优</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/MyWifeMyLife.html">My Wife, My Life－七夕</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/21/AccessControlSystem.html">Access-Control-System</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/good-to-great-2.html">《Good-To-Great》-“人与方向”</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/good-to-great.html">《Good To Great》- “窗子与镜子”</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/22/ProgrammingLanguages-GarbageCollection.html">Garbage Collection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/11/rest-api.html">REST API与云计算</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/11/x-forwarded-for.html">HTTP之X-Forwarded-For</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/gopherchina2016.html">GopherChina2016</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/The-Murphy-s-law.html">墨菲定律(The-Murphy's-law)</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//httpworkjlsungithubio.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://andremouche.github.io/" title="Shirly-blog" target="_blank">Shirly-blog</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">Tom Talk.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></body><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>$(document).ready(function() {
  $('img').each(function() {
    if ($(this).parent().hasClass('fancybox')) return;
    if ($(this).hasClass('nofancybox')) return;
    var alt = this.alt;
    if (alt) $(this).after('<span class="caption">' + alt + '</span>');
    $(this).wrap('<a href="' + ($(this).attr('data-src') == null ? this.src : $(this).attr('data-src')) + '" title="' + alt + '" class="fancybox"></a>');
  });
  $(this).find('.fancybox').each(function(){
    $(this).attr('rel', 'article');
  });
});</script><script>$(document).ready(function() {
  $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
   helpers : {
   title: { type: 'inside'}
   }
 });
});
</script></html>