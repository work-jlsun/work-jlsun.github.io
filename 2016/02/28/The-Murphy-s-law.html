<a id="rocket" href="#top" class="show"></a><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>墨菲定律(The-Murphy's-law) | Tom Talk</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">墨菲定律(The-Murphy's-law)</h1><a id="logo" href="/">Tom Talk</a><p class="description">分享我的实践、思考、积累</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">墨菲定律(The-Murphy's-law)</h1><div class="post-meta">2016-02-28 | </div><span data-disqus-identifier="/2016/02/28/The-Murphy-s-law.html" class="disqus-comment-count"></span><div class="post-content"><h3 id="墨菲定律（The-Murphy’s-law）">墨菲定律（The-Murphy’s-law）</h3><p>“Anything that can go wrong, will go wrong.”－任何可能发生的事情，都将发生。</p>
<p>当然墨菲定律并没有说发生的事情是好是坏，因为好坏都是人为界定的；但是人们往往都用它来说明一些只有在极端苛刻条件下才能发生的糟糕事情。</p>
<p>对于我们IT工程师，往往需要对这个定律更加怀有一份敬畏之心。因为程序逻辑被调用的越多，那么理论上任何潜在的程序分支都会被跑到，任何潜在的bug都会发生。特别是在如今的云计算大环境下，越来越多的企业将自己的服务迁移到第三方厂商的云服务平台，所以云服务厂商程序的调用频繁度，和生命周期都是远远高于以往，墨菲定律的发生周期将被大大缩短。所以对于在大型云服务厂商coding的程序员们需要将格外敬畏。</p>
<h3 id="潜伏Bug">潜伏Bug</h3><p>此次谈一谈在我们系统中潜伏将近2年多的BUG。涉及的是对象存储服务提供的分块上传功能。</p>
<p>在对象存储系统中，为了提高大文件的上传成功率和对特大文件的支持，提供了“分块上传”功能，即将文件切成更小的分块进行上传，其功能的实现主要通过如下三个接口。</p>
<ul>
<li>InitMultiUpload: 初始化一次分块上传，返回唯一UploadID用于串联后续每个分块的上传。</li>
<li>UploadPart: 将文件均匀拆分成几个块，上传每一分块数据。</li>
<li>CompleteMultiUpload：所有分块上传完毕，提交所有分块的元信息合并成一个文件。</li>
</ul>
<p>接口可参见<a href="http://docs.aws.amazon.com/AmazonS3/latest/API/mpUploadInitiate.html" target="_blank" rel="external">AWS OSS 分块接口</a>。</p>
<p><img src="/media/files/2016/03/multipartupload.jpg" alt="multipartupload.jpg"></p>
<h4 id="数据库表设计">数据库表设计</h4><p>分块上传主要设计3张数据库表。</p>
<ul>
<li>NOS_UploadInfo表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`NOS_UploadInfo`</span> (</span><br><span class="line">  <span class="string">`UploadID`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'上传SessionID'</span>,</span><br><span class="line">  <span class="string">`ObjectName`</span> <span class="built_in">varchar</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'对象名称，桶内唯一'</span>,</span><br><span class="line">   .....略......</span><br><span class="line">)</span></span><br></pre></td></tr></table></figure>
<p>InitiateMultiUpload操作会向NOS_UploadInfo表里插入一条记录，同时给用户返回一个UploadId，以后该对象的所有分块上传都要带着这个UploadID。</p>
<ul>
<li>NOS_UploadPart表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`NOS_UploadPart`</span> (</span><br><span class="line">  <span class="string">`UploadID`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'所属上传SessionID'</span>,</span><br><span class="line">  <span class="string">`DocID`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'对应的DFSDocID'</span>,</span><br><span class="line">  <span class="string">`Sequence`</span> <span class="built_in">smallint</span>(<span class="number">5</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'分块序号'</span>,</span><br><span class="line">  <span class="string">`Size`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'本分块长度'</span>,</span><br><span class="line">    .....略......</span><br><span class="line">)</span></span><br></pre></td></tr></table></figure>
<p>每次调用UploardPart都会向NOS_UploadPart表中插入一条记录对应一个分块信息，DocId用于索引存储引擎文件的ID，Sequence为分块序号，Size为本分块的长度。</p>
<ul>
<li>NOS_AbandonUploadPart表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`NOS_AbandonUploadPart`</span> (</span><br><span class="line">  <span class="string">`DocID`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'废弃docid'</span>,</span><br><span class="line">  <span class="string">`CTime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'废弃时间'</span>,</span><br><span class="line">    .....略......</span><br><span class="line">)</span></span><br></pre></td></tr></table></figure>
<p>NOS_Uploadpart的主键为 (<code>UploadID</code>,<code>Sequence</code>)，当重复上传某个分块的时候，被覆盖的信息会插入NOS_AbandonUploadPart表中。</p>
<p><strong>注意：此数据库表中记录的DocID对应的存储引擎文件最终是没有实际对象会引用的,所以清理程序会周期性对NOS_AbandonUploadPart中的对象进行清理。</strong></p>
<h4 id="数据库逻辑">数据库逻辑</h4><p>在所有分块上传成功之后，调用CompleteMultiUpload完成分块上传，此操作涉及的数据库逻辑如下所示。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(逻辑A) <span class="operator"><span class="keyword">select</span> DocID, <span class="keyword">Sequence</span>, <span class="keyword">Size</span>, ETag, LastModify <span class="keyword">from</span> NOS_UploadPart <span class="keyword">where</span> UploadID = ? <span class="keyword">and</span> <span class="keyword">Sequence</span> &gt; ? <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">Sequence</span> <span class="keyword">asc</span> <span class="keyword">limit</span> ?<span class="string">" </span><br><span class="line">(逻辑B) 事务 &#123;</span><br><span class="line">	delete from NOS_UploadPart where UploadID = ?"</span></span><br><span class="line">	<span class="keyword">delete</span> <span class="keyword">from</span> NOS_UploadInfo <span class="keyword">where</span> UploadID = ? <span class="keyword">and</span> IsAbort = <span class="number">0</span></span><br><span class="line">	使用上述DocID <span class="keyword">List</span> 执行一次PUT <span class="keyword">Object</span> <span class="keyword">SQL</span>逻辑</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其实仔细分析这个数据库逻辑，我们会发现是有问题的，因为在逻辑A和逻辑B之间有可能会有一次UploadPart操作覆盖前一次的分块，即逻辑A中获取到的DocId可能会被逻辑B之前插入的UploadPart操作丢入NOS_AbandonUploadPart列表。</p>
<p>对于此接口，接口的使用者一般都会选择不同分块之间进行并发上传(UploadPart)以提供上传速度，而不会对同一分块进行并发上传(没有必要)。<strong>而实际上，发生问题的原因也并非用户并发调用同一分块上传所致, 而是由于我们系统的负载日益增大，内网万M上行网卡水位满，导致用户UploadPart调用超时从而进行重试，而某个组件处理此请求的时间由于网卡满导致执行的时间较长，在用户返回超时的时候还在执行。延时执行的请求和后续用户的重试形成了一次并发UploadPart操作。。。。</strong></p>
<h4 id="系统日志">系统日志</h4><p>错误发生场景：外部调用者设置的超时时间为15s，内部模块执行耗时15s以上。如下日志所示，第二条UPLOAD_PART日志即为由于内部负载过高而延迟执行的请求，其overhead为 16621，即16s以上。而第一条日志为后续用户重试的日志，然后悲剧就发生了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[INFO ]<span class="number">2016</span>-<span class="number">02</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">25</span>,<span class="number">313</span>,[Class]NosResponse, &#123;nossvr:UPLOAD_PART, overhead:<span class="number">147</span>, requestID:ee1e572b0aa000000153097300ee840f, productID:NosUp, resource:/imglf2/img/cUwreko1OTc1UG01RWR5K2kra0NWN1VXS1k2bjN1OHdqckxwMTloSEY4RitSUGRtYk4rVE5BPT0.jpg, logID:<span class="number">7</span>c69b3f0-<span class="number">3</span>b77-<span class="number">4</span>ecc-<span class="number">96</span>cc-<span class="number">5</span>a75e424d102, CmdSpecInfo:UploadPartCommand [partNumber=<span class="number">3</span>, uploadId=<span class="number">4561524247931778940</span>, uploadPart=UploadPart [uploadID=<span class="number">4561524247931778940</span>, docID=<span class="number">88970281898321691</span>, sequence=<span class="number">3</span>, size=<span class="number">1048576</span>, lastModify=<span class="number">1456152445298</span>, eTag=<span class="number">1e81</span>ff2e17fdcf78fe4c9ef9d76d04f3, isCommit=<span class="literal">false</span>]], Date:null&#125;[WARN ]<span class="number">2016</span>-<span class="number">02</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26</span>,<span class="number">788</span>,[Class]NosResponse, &#123;nossvr:UPLOAD_PART, overhead:<span class="number">16621</span>, requestID:<span class="number">1</span>c0793450aa0000001530972c657849a, productID:NosUp, resource:/imglf2/img/cUwreko1OTc1UG01RWR5K2kra0NWN1VXS1k2bjN1OHdqckxwMTloSEY4RitSUGRtYk4rVE5BPT0.jpg, logID:a8cb0c09-<span class="number">44</span>b7-<span class="number">4588</span>-<span class="number">91</span>b8-<span class="number">9</span>cdb7b7e1b0b, CmdSpecInfo:UploadPartCommand [partNumber=<span class="number">3</span>, uploadId=<span class="number">4561524247931778940</span>, uploadPart=UploadPart [uploadID=<span class="number">4561524247931778940</span>, docID=<span class="number">89389195827348221</span>, sequence=<span class="number">3</span>, size=<span class="number">1048576</span>, lastModify=<span class="number">1456152446703</span>, eTag=<span class="number">1e81</span>ff2e17fdcf78fe4c9ef9d76d04f3, isCommit=<span class="literal">false</span>]], Date:null&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Murphy-s-law/">Murphy's law</a><a href="/tags/分布式/">分布式</a></div><div class="post-nav"><a href="/2016/03/01/gopherchina2016.html" class="pre"><i class="icon-previous">GopherChina2016</i></a><a href="/2016/02/24/shikong.html" class="next">生命的群体效应 -《失控》<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'httpworkjlsungithubio';
var disqus_identifier = '/2016/02/28/The-Murphy-s-law.html';
var disqus_title = '墨菲定律(The-Murphy's-law)';
var disqus_url = 'http://yoursite.com//2016/02/28/The-Murphy-s-law.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//httpworkjlsungithubio.disqus.com/count.js" async="async"></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/CDN/" style="font-size: 15px;">CDN</a> <a href="/tags/HTTP-API/" style="font-size: 15px;">HTTP API</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Murphy-s-law/" style="font-size: 15px;">Murphy's law</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/浪漫/" style="font-size: 15px;">浪漫</a> <a href="/tags/古典/" style="font-size: 15px;">古典</a> <a href="/tags/云存储/" style="font-size: 15px;">云存储</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/交流/" style="font-size: 15px;">交流</a> <a href="/tags/云存储、cdn/" style="font-size: 15px;">云存储、cdn</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/performance/" style="font-size: 15px;">performance</a> <a href="/tags/goroutine/" style="font-size: 15px;">goroutine</a> <a href="/tags/storage/" style="font-size: 15px;">storage</a> <a href="/tags/consistency/" style="font-size: 15px;">consistency</a> <a href="/tags/avaliable/" style="font-size: 15px;">avaliable</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/04/22/ProgrammingLanguages-GarbageCollection.html">ProgrammingLanguages-GarbageCollection</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/11/rest-api.html">REST API与云计算</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/11/x-forwarded-for.html">HTTP之X-Forwarded-For</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/gopherchina2016.html">GopherChina2016</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/The-Murphy-s-law.html">墨菲定律(The-Murphy's-law)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/24/shikong.html">生命的群体效应 -《失控》</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/22/code.html">一道笔试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/08/Zen-and-the-Art-of-Motorcycle-Maintenance.html">Zen and the Art of Motorcycle Maintenance</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/09/facebook_photo_caching.html">Facebook图片服务堆栈浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/23/youpai_communicate.html">又拍云交流</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//httpworkjlsungithubio.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://andremouche.github.io/" title="Shirly-blog" target="_blank">Shirly-blog</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">Tom Talk.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></body><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>$(document).ready(function() {
  $('img').each(function() {
    if ($(this).parent().hasClass('fancybox')) return;
    if ($(this).hasClass('nofancybox')) return;
    var alt = this.alt;
    if (alt) $(this).after('<span class="caption">' + alt + '</span>');
    $(this).wrap('<a href="' + ($(this).attr('data-src') == null ? this.src : $(this).attr('data-src')) + '" title="' + alt + '" class="fancybox"></a>');
  });
  $(this).find('.fancybox').each(function(){
    $(this).attr('rel', 'article');
  });
});</script><script>$(document).ready(function() {
  $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
   helpers : {
   title: { type: 'inside'}
   }
 });
});
</script></html>