<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Nginx 性能调优 | Tom Talk</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx 性能调优</h1><a id="logo" href="/.">Tom Talk</a><p class="description">分享我的实践、思考、积累</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx 性能调优</h1><div class="post-meta">Sep 1, 2016<!--script(src='https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js', async)--><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="/2016/09/01/tunning-nginx-performance.html" href="/2016/09/01/tunning-nginx-performance.html#comments" class="ds-thread-count"></a><br class="clear"><div class="post-ref"><blockquote><p>本文由tom原创，转载请注明原文链接：<a href="https://work-jlsun.github.io//2016/09/01/tunning-nginx-performance.html">https://work-jlsun.github.io//2016/09/01/tunning-nginx-performance.html</a></p></blockquote></div><div class="post-content"><h3 id="1-缘起"><a href="#1-缘起" class="headerlink" title="1. 缘起"></a>1. 缘起</h3><p><a href="https://c.163.com/product/nos" target="_blank" rel="external">oss公有云</a>新发布上线公测，遇到一个做营销的客户，利用我们oss服务域名资源做导流，尴尬的是直接导致我们126.net顶级域名在微信中被封了，于是让运维童鞋将对应的域名进行了封禁。</p>
<p>然后就狗血了，人立马对我们进行了一次报复攻击，欺负我们刚上线发布。</p>
<p>虽然是一次规模较小的攻击，系统资源也远远没有达到极限，但是由于有是公测阶段相关的一些调优措施尚未执行，所以确实也出现了一些问题。（间接达到了一定公测的作用）</p>
<p>系统的表现为出现大量的TIME_WAIT的TCP连接, Nginx 与后端服务器之间建立不了连接，打印大量 <strong>“Cannot assign requested address”</strong>， 连接不上后端的Proxy。</p>
<pre><code>2016/08/30 21:24:22 [crit] 120552#0: *55903928 connect() to 10.176.xx.xx:8181 failed (99: Cannot assign requested address) while connecting to upstream, client: 115.236.xxx.xxx, server: nos-eastchina1.126.net, request: &quot;GET /404 HTTP/1.0&quot;, upstream:&quot;http://10.176.14.xx:8181/tom/404&quot;, host: &quot;tom.nos-eastchina1.126.net&quot;
</code></pre><p><img src="/media/files/2016/08/time_wait.jpg" alt="xxx"></p>
<p>从连接状态监控统计图可以看到，TIME-WAIT 量很大，但是比量大更加重要的一点是，10几分钟的时间内，TIME-WAIT这条曲线是平的。如同心率，在微观角度，平意味着停止抑或是死亡，这应该在人工系统和生物系统中都是一样的，这代表系统出故障。</p>
<h3 id="2-问题分析"><a href="#2-问题分析" class="headerlink" title="2. 问题分析"></a>2. 问题分析</h3><p>那么首先从表象来分析发生问题的原因。<strong>Cannot assign requested address</strong> 表示Nginx与后端服务器的连接端口用尽。那就先分析当前Nginx所在机器连接的状态(PS:为了快速查看和保留现场)</p>
<p><strong>ss -s</strong> 快速看到当前网络连接基本连接状态（以下非现场）。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[tom@localhost ~]$ ss -s</div><div class="line">Total:<span class="number"> 1065 </span>(kernel 0)</div><div class="line">TCP:  <span class="number"> 8 </span>(estab 1, closed 1, orphaned 0, synrecv 0, timewait 0/0), ports 0</div><div class="line"></div><div class="line">Transport Total     IP        IPv6</div><div class="line">*	 <span class="number"> 0 </span>        -         -</div><div class="line">RAW	 <span class="number"> 1 </span>       <span class="number"> 0 </span>        1</div><div class="line">UDP	 <span class="number"> 9 </span>       <span class="number"> 6 </span>        3</div><div class="line">TCP	 <span class="number"> 7 </span>       <span class="number"> 4 </span>        3</div><div class="line">INET	 <span class="number"> 17 </span>      <span class="number"> 10 </span>       7</div><div class="line">FRAG	 <span class="number"> 0 </span>       <span class="number"> 0 </span>        0</div></pre></td></tr></table></figure>
<p><strong>ss -a &gt;&gt; /tmp/ssinfo</strong> 将当前连接的详请保留以备分析(以下非现场)。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">hzsun@cyq9<span class="symbol">:~</span>$ ss -a <span class="meta">&gt;&gt; </span>/tmp/ssinfo</div><div class="line">hzsun@cyq9<span class="symbol">:~</span>$ head /tmp/ssinfo</div><div class="line">State      Recv-Q Send-Q      Local <span class="symbol">Address:</span>Port          Peer <span class="symbol">Address:</span>Port</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>            <span class="number">106.2</span>.x.<span class="number">9</span><span class="symbol">:</span><span class="number">5001</span>                     *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                     *<span class="symbol">:</span><span class="number">49325</span>                    *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>            <span class="number">106.2</span>.x.<span class="number">9</span><span class="symbol">:</span><span class="number">5999</span>                     *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                    <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:sunrpc</span>                  <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                     *<span class="symbol">:sunrpc</span>                   *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                     *<span class="symbol">:http</span>                     *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                     *<span class="symbol">:tproxy</span>                   *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>            <span class="number">106.2</span>.x.<span class="number">9</span><span class="symbol">:</span><span class="number">12306</span>                    *<span class="symbol">:*</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                     *<span class="symbol">:</span><span class="number">8082</span>                     *<span class="symbol">:*</span></div></pre></td></tr></table></figure>
<p>分析发现主要是Nginx与后端Proxy之前出现了大量的TIME-WAIT连接，也就是Nginx频繁主动关闭与后端的连接。</p>
<p><strong>step1</strong></p>
<p>那么首先想到的是，Nginx与后端之间有没有强制使用HTTP 1.1 KeepAlive 长连接? ok，检查下Nginx的配置（或者直接tcpdump抓包进行验证）</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">   	<span class="section">listen</span>  <span class="number">80</span>;</div><div class="line">   	<span class="section">listen</span>  <span class="number">443</span> ssl;</div><div class="line"></div><div class="line">   	# Force HTTP <span class="number">1.1</span>(可以看到在server 模块已经强制到后端的连接为长连接)</div><div class="line">   	proxy_http_version <span class="number">1.1</span>;</div><div class="line">   	proxy_set_header Connection <span class="string">""</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>check没有啥问题。</p>
<p><strong>step2</strong></p>
<p>既然Nginx与后端服务器已经使用长连接，那么接下来我们看下另外一个Nginx参数。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">	upstream <span class="keyword">backend_proxy </span>&#123;  </div><div class="line">    <span class="comment">#depend on config online        </span></div><div class="line">        server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8181</span><span class="comment">;</span></div><div class="line">        server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8182</span><span class="comment">;</span></div><div class="line">        server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8181</span><span class="comment">;</span></div><div class="line">        server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8182</span><span class="comment">;</span></div><div class="line">    	 keepalive <span class="number">128</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>keepalive: 也就是Nginx与这些后端服务器维护的 <strong>长连接池的大小</strong> 。keepalive 128指的是nginx与所有这些4个server之间建立的长连接池的大小。128并不是说与这些后端servers这间只能建立128个连接，而是持续与后端维持的连接的数量；当并发超过128的情况下，nginx会与后端建立超过128个连接，比如129，当第129个连接使用完(处理完客户请求)归还到连接池的时候，发现连接池128个已满的情况下，会强行把第129个连接强行进行关闭，那么这条连接就会处于TIME-WAIT状态。</li>
</ul>
<p>也就是说如果这个值配置得过小，比如是10，而你的服务又有很大的负载的情况下。那么就会频繁得创建连接，关闭连接，那么自然会导致出现非常非常多的处于TIME-WAIT状态的TCP连接。</p>
<p><img src="/media/files/2016/08/tcp_stat.png" alt="xxx"></p>
<p>ok，那么是不是应该调整这个的值？什么样的值和合适。一般来说评估手段如下</p>
<p>keepalive = qps/(1000/请求平均响应时间)</p>
<p>比如10w qps ； 平均响应时间50ms，则keepalive ＝ 100000/（1000/50）＝5000；一般来说这个值已经够用了。</p>
<p>另外这个值配置的大小还受其他几个因素的影响。</p>
<ol>
<li><p>后端服务器是否为per conntion per thread 方式(比如tomcat)，如果是，实际能用的连接池还跟后端servers线程池的总体大小有关。</p>
</li>
<li><p>系统资源： 内存、fd资源（每open一个socket，都需要fd资源）、系统可用零时端口数等等</p>
</li>
</ol>
<p>以下就详细说明我们作的一些基本的调优工作。</p>
<h3 id="3-Tunning-Nginx-Performace"><a href="#3-Tunning-Nginx-Performace" class="headerlink" title="3. Tunning Nginx Performace"></a>3. Tunning Nginx Performace</h3><ul>
<li>FD 调优</li>
</ul>
<p><strong>系统层次</strong></p>
<p>系统打开文件和socket都是需要FD（<a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="external">File_descriptor</a>），可以使用的最大的fd的数量取决于系统可以使用的内存数量，一般1GB的内存可以支持打开的文件描述符大概在10万个左右, linux系统本身有最大FD的限制，我们可以通过cat /proc/sys/fs/file-max的方式进行查看。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sun@linux:~$ cat /<span class="keyword">proc</span>/sys/fs/<span class="keyword">file</span>-<span class="keyword">max</span></div><div class="line"><span class="number">3249623</span></div></pre></td></tr></table></figure>
<p>查看内存(如下)可以得知，系统内存的大小为32G，与上面file-max值基本匹配。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hzsun@3:~$ free -m</div><div class="line">           	 total       used       free     shared    buffers     cached</div><div class="line">Mem:        <span class="number"> 32134 </span>    <span class="number"> 30510 </span>     <span class="number"> 1624 </span>        <span class="number"> 0 </span>      <span class="number"> 293 </span>     17672</div><div class="line">-/+ buffers/cache:     <span class="number"> 12543 </span>     19591</div><div class="line">Swap:        <span class="number"> 4095 </span>       <span class="number"> 14 </span>      4081</div></pre></td></tr></table></figure>
<p><strong>进程总体层次</strong></p>
<p>nginx.conf中参数worker_rlimit_nofile决定nginx单个worker可以打开最大的文件描述符的数量，没有设置的话则受到系统的ulimit(ulimit -n)约束，假设系统也没设置那么默认为2048。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">worker_processes <span class="number">16</span><span class="comment">;</span></div><div class="line">user nos nos<span class="comment">;</span></div><div class="line">worker_rlimit_nofile <span class="number">65536</span><span class="comment">;</span></div><div class="line">worker_rlimit_core  <span class="number">500</span>M<span class="comment">;</span></div></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hzsunjiag<span class="meta">@nos</span>-<span class="string">front3:</span>~$ ulimit -n</div><div class="line"><span class="number">655360</span></div><div class="line">hzsunjianliang<span class="meta">@nos</span>-<span class="string">front3:</span>~$</div></pre></td></tr></table></figure>
<p>如上配置可以看到在代理模式下，当前fd的数量能够限制的最大并发链接数量约为：</p>
<p>max_client = worker_processes <em> worker_rlimit_nofile / 2 =  16 </em> 65536  = 1048560 。就FD层次而言，能够限制的最大并发连接数已经在百万级别了。</p>
<p>所以当你下次遇到Nginx出现 <strong>“Two Many Open Files”</strong> 的时候，注意对以上这些FD相关的参数进行调整就可以了。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">2015</span>/<span class="selector-tag">10</span>/<span class="selector-tag">27</span> <span class="selector-tag">21</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:36</span> <span class="selector-attr">[crit]</span> <span class="selector-tag">2475</span><span class="selector-id">#0</span>: <span class="selector-tag">accept4</span>() <span class="selector-tag">failed</span> (<span class="number">24</span>: Too many open files) <span class="selector-tag">2015</span>/<span class="selector-tag">10</span>/<span class="selector-tag">27</span> <span class="selector-tag">21</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:36</span> </div><div class="line"><span class="selector-attr">[alert]</span> <span class="selector-tag">2475</span><span class="selector-id">#0</span>: *<span class="selector-tag">7163915</span> <span class="selector-tag">socket</span>() <span class="selector-tag">failed</span> (<span class="number">24</span>: Too many open files) <span class="selector-tag">while</span> <span class="selector-tag">connecting</span> <span class="selector-tag">to</span> <span class="selector-tag">upstream</span></div></pre></td></tr></table></figure>
<p><strong>单个进程层次</strong></p>
<p>单个进程能够建立的连接和单个进程能够打开的fd数量也是直接相关的因素。worker_connections &lt; worker_rlimit_nofile；一般来说2:3 应该算是一个不错的比例了。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>;</div><div class="line"><span class="section">events</span> &#123;</div><div class="line">    <span class="attribute">worker_connections</span> <span class="number">45000</span>;</div><div class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ps：nginx为了防止惊群效应，在epoll唤醒的时候会首先去获取一把锁，之后获取锁的进程去accept所有的已经激活(完成三次握手)的连接，nginx被压得时候，大量连接同一时刻到达，导致大量连接被一个worker获取。（这个在调优的时候有时候可以关注一下）</p>
<ul>
<li>系统临时端口数</li>
</ul>
<p>Nginx在作为代理的情况下，会随机分配一个临时端口与后端服务器建立连接。如下Nginx的IP为10.176.xx.13；后端服务器的IP包括10.176.xx.25、10.176.xx.26。后端服务器的监听端口就是8182；28671、24703为Nginx作为客户端建立与后端的连接时分配的临时分配。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">hzsun@linux:~$ netstat -an </div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">28671</span>      <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">25</span>:<span class="number">8182</span>       ESTABLISHED</div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">24703</span>      <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">25</span>:<span class="number">8182</span>       ESTABLISHED</div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">24689</span>      <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">26</span>:<span class="number">8182</span>       ESTABLISHED</div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">28725</span>      <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">26</span>:<span class="number">8182</span>       ESTABLISHED</div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">28706</span>      <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">25</span>:<span class="number">8182</span>       ESTABLISHED</div><div class="line"></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">10.176</span><span class="selector-class">.xx</span>.<span class="number">13</span>:<span class="number">24658</span>      <span class="number">10.176</span>.<span class="number">14.25</span>:<span class="number">8182</span>       ESTABLISHED</div></pre></td></tr></table></figure>
<p>临时端口的选择范围是有限制的,可以通过ip_local_port_range查看零时端口的选择范围，如下所示为默认情况下的选择范围，零时端口的个数为28232个，可以适当进行调整，比如我们调整为61000~20000。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">hzsun@nos<span class="symbol">:~</span>$ cat /proc/sys/net/ipv4/ip_local_port_range</div><div class="line"><span class="number">32768</span>	<span class="number">61000</span></div><div class="line">hzsun@nos<span class="symbol">:~</span>$ python</div><div class="line">Python <span class="number">2.7</span>.<span class="number">3</span> (default, Mar <span class="number">13</span> <span class="number">2014</span>, <span class="number">11</span><span class="symbol">:</span><span class="number">03</span><span class="symbol">:</span><span class="number">55</span>)</div><div class="line">[GCC <span class="number">4.7</span>.<span class="number">2</span>] on linux2</div><div class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line"><span class="meta">&gt;&gt;</span>&gt; <span class="number">61000</span> - <span class="number">32768</span></div><div class="line"><span class="number">28232</span></div></pre></td></tr></table></figure>
<p>那么这样以来Nginx 与后端服务器之间建立的连接能够达到多少？</p>
<p>TCP协议是通过 srcIp:srcPort  DstIP:DestPort 这样一个四元组来唯一确定一条连接。也就是说Nginx与后端建立的连接数页受如下公式的限制</p>
<p>MaxUpstremConnNum =  (61000-32768)* NumberOfUpstreams</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">upstream <span class="keyword">backend_proxy </span>&#123;  </div><div class="line">	<span class="comment">#depend on config online        </span></div><div class="line">	server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8181</span><span class="comment">;</span></div><div class="line">	server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8182</span><span class="comment">;</span></div><div class="line">	server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8181</span><span class="comment">;</span></div><div class="line">	server <span class="number">10</span>.xx.<span class="number">14</span>.xx:<span class="number">8182</span><span class="comment">;</span></div><div class="line">   	keepalive <span class="number">128</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上 MaxUpstremConnNum ＝ 112928</p>
<ul>
<li>TIME-WAIT</li>
</ul>
<p>最后回到本源，为什么需要TIME-WAIT?TIME-WAIT为什么需要这么长的时间才能够进行回收? 可以参考 CoolShell<a href="http://coolshell.cn/articles/11564.html" target="_blank" rel="external">《TCP 的那些事儿（上）》</a>，里头有详细的说明。TIME-WAIT优化属于黑科技，不要万不得已不要玩。这里就不再鳌述了。</p>
<h4 id="4-参考文献"><a href="#4-参考文献" class="headerlink" title="4 参考文献"></a>4 参考文献</h4><ul>
<li><a href="http://skyao.github.io/leaning-nginx/documentation/keep_alive.html" target="_blank" rel="external">http://skyao.github.io/leaning-nginx/documentation/keep_alive.html</a></li>
<li><a href="http://coolshell.cn/articles/11564.html" target="_blank" rel="external">http://coolshell.cn/articles/11564.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="external">https://en.wikipedia.org/wiki/File_descriptor</a></li>
</ul>
<hr><p>This article used CC-BY-SA-4.0 license, please follow it.</p></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://work-jlsun.github.io//2016/09/01/tunning-nginx-performance.html" data-id="cj1ya9dyv001dnpy7du7d3bk4" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Nginx/">Nginx</a><a href="/tags/Tunning/">Tunning</a><a href="/tags/性能/">性能</a></div><div class="post-nav"><a href="/2016/11/19/S3-HowTo-Dealwith-listObject.html" class="pre">S3 HowTo Dealwith ListObject</a><a href="/2016/08/09/MyWifeMyLife.html" class="next">My Wife, My Life－七夕</a></div><div data-thread-key="/2016/09/01/tunning-nginx-performance.html" data-title="Nginx 性能调优" data-url="https://work-jlsun.github.io//2016/09/01/tunning-nginx-performance.html" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="/2016/09/01/tunning-nginx-performance.html" data-title="Nginx 性能调优" data-url="https://work-jlsun.github.io//2016/09/01/tunning-nginx-performance.html" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://work-jlsun.github.io"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://work-jlsun.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/performance/" style="font-size: 15px;">performance</a> <a href="/tags/storage/" style="font-size: 15px;">storage</a> <a href="/tags/consistency/" style="font-size: 15px;">consistency</a> <a href="/tags/avaliable/" style="font-size: 15px;">avaliable</a> <a href="/tags/goroutine/" style="font-size: 15px;">goroutine</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/交流/" style="font-size: 15px;">交流</a> <a href="/tags/云存储、cdn/" style="font-size: 15px;">云存储、cdn</a> <a href="/tags/云存储/" style="font-size: 15px;">云存储</a> <a href="/tags/CDN/" style="font-size: 15px;">CDN</a> <a href="/tags/浪漫/" style="font-size: 15px;">浪漫</a> <a href="/tags/古典/" style="font-size: 15px;">古典</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/Murphy-s-law/" style="font-size: 15px;">Murphy's law</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/HTTP-API/" style="font-size: 15px;">HTTP API</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/Pragraming-Languages/" style="font-size: 15px;">Pragraming Languages</a> <a href="/tags/阅读/" style="font-size: 15px;">阅读</a> <a href="/tags/从优秀到卓越/" style="font-size: 15px;">从优秀到卓越</a> <a href="/tags/S3/" style="font-size: 15px;">S3</a> <a href="/tags/Tunning/" style="font-size: 15px;">Tunning</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/存储/" style="font-size: 15px;">存储</a> <a href="/tags/分布式、存储/" style="font-size: 15px;">分布式、存储</a> <a href="/tags/分布式、存储、可靠性/" style="font-size: 15px;">分布式、存储、可靠性</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/18/copyset-replication.html">副本放置&Copyset Replication</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/28/a-finding-in-perftest.html">数据存储中Zipf分布</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/a-hdd-disk-test.html">硬盘性能简测</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/17/storage-physical-topoloy.html">大规模存储物理架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/19/storage-durablity-design-pattern.html">分布式存储系统可靠性-设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/18/storage-durablity-2.html">分布式存储系统可靠性-系统估算示例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/24/storage-durablity.html">分布式存储系统可靠性-如何估算</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/22/uploadsystem.html">网易云对象存储服务发布**“直传加速服务”**</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/splitDataWithSalt.html">Split Data With Salt</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/nos-from-0-1.html">“网易云存储服务”从0到1发展之路</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://andremouche.github.io" title="Shirly-Blog" target="_blank">Shirly-Blog</a><ul></ul><a href="http://michael-j.net/" title="michael-j" target="_blank">michael-j</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Tom Talk.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'work-jlsun'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>