<a id="rocket" href="#top" class="show"></a><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>分布式存储系统可靠性-系统估算示例 | Tom Talk</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分布式存储系统可靠性-系统估算示例</h1><a id="logo" href="/">Tom Talk</a><p class="description">分享我的实践、思考、积累</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">分布式存储系统可靠性-系统估算示例</h1><div class="post-meta">2017-02-18 | </div><span data-disqus-identifier="/2017/02/18/storage-durablity-2.html" class="disqus-comment-count"></span><div class="post-content"><h4 id="1_估算示例">1 估算示例</h4><p>上文<a href="https://work-jlsun.github.io/2017/01/24/storage-durablity.html" target="_blank" rel="external">分布式存储系统可靠性-如何估算</a>中，我们提供了一些基本的估算的方法。接下来我们提供一个具体的估算的示例子。</p>
<p>系统示例: N = 7200块磁盘的存储系统中，R=3副本，单盘容量 DiskSize = 8T,磁盘年平均故障率 AFR = 4%，系统采用大多数存储系统采用的小文件合并成大文件分片的方式存储，分片大小为PartSize = 10GB，系统整体空间利用率Percent =70%(系统总体承载数据量大约在13PB)，分片采用随机放置方式,随机放置情况下 S = Min(C(R,N), (N*DiskSize*Percent/R)/T) 。</p>
<p><strong>以下为计算恢复时间 1 小时情况下的概率的过程</strong></p>
<pre><code>S =  Min( C(<span class="number">3</span>, <span class="number">7200</span>), <span class="number">7200</span> * <span class="number">8</span> * <span class="number">1024</span> * <span class="number">70</span>% / <span class="number">3</span> / <span class="number">10</span>) = <span class="number">1376256</span>

P(T,K) = P(<span class="number">1</span>,K) = ( X / C(K,<span class="number">7200</span>) ) * P( N(<span class="number">1</span>) = K)

λ = <span class="number">4</span>% * <span class="number">7200</span> /<span class="number">365</span>/<span class="number">24</span> = <span class="number">0.03</span> (按照<span class="number">4</span>%的换盘率计算<span class="number">999</span>块盘的系统中平均每小时的换盘数量)

P( N(<span class="number">1</span>) = K) = (λ**K) *  (e ** -λn)/K!

P(T) = Σ P(<span class="number">1</span>,K) ; K∈[<span class="number">3</span>, <span class="number">7200</span>] 

P = <span class="number">1</span> - (<span class="number">1</span>-P(T))\*\*(<span class="number">365</span>\*<span class="number">24</span>/<span class="number">1</span>)
</code></pre><p>可以看到其中 选K个节点情况下，命中copyset的概率为 X/ C(K, 7200)。 这个X的计算我们暂时还没有确定，我们看下这个如何计算</p>
<p>K = 3 的情况下，即P（1，3）= S/C(7200,3) <em> P( N(1) = 3) 比较简单，但是在K∈[4, 7200]点情况下，情况就比较复杂了，貌似没有一种比较好的统一的组合概率计算这个概率。如果非要计算基本可以使用</em>蒙特卡罗**方法case by case 进行计算，该方法详见附录。如果我们在分析概率的基础上进行进一步简化估算。</p>
<p>通过计算P(N(1),K)  可以计算得到1小时内坏K个的概率</p>
<table>
<thead>
<tr>
<th>K</th>
<th>P(N(1), K)</th>
<th>P(1,K)</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>5.73e-6</td>
<td>1.26e-10</td>
</tr>
<tr>
<td>4</td>
<td>4.71e-8</td>
<td>?</td>
</tr>
<tr>
<td>5</td>
<td>3.09e-10</td>
<td>?</td>
</tr>
<tr>
<td>6</td>
<td>1.69e-12</td>
<td>?</td>
</tr>
<tr>
<td>7</td>
<td>7.97e-15</td>
<td>?</td>
</tr>
<tr>
<td>8</td>
<td>3.27e-17</td>
<td>?</td>
</tr>
<tr>
<td>9</td>
<td>1.19e-19</td>
<td>?</td>
</tr>
</tbody>
</table>
<p>从上面我们可以看到，在K &gt;= 6情况下，假设选中copyset的概率为1，对结果的影响也是比k=3小2个数量级以上。所以基本只需要统计考虑K = 4，K=5 情况下的即可。K=4，5 情况下的选中CopySet的概率 基本为 C(S,1) * C(N-3, K-3) / C(N,K)。</p>
<table>
<thead>
<tr>
<th>K</th>
<th>P(N(1), K)</th>
<th>P(1,K)</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>5.73e-6</td>
<td>1.26e-10</td>
</tr>
<tr>
<td>4</td>
<td>4.71e-8</td>
<td>4.17e-12</td>
</tr>
<tr>
<td>5</td>
<td>3.09e-10</td>
<td>6.85e-14</td>
</tr>
</tbody>
</table>
<p>P(T) ~=  Σ P(1,K) ; K∈[3, 5] = 1.31e-10 (<br>即t=1 小时内 丢数据的概率为1.31e-1)</p>
<p>P = P = 1 - (1-P(T))<em>*(365</em>24/T) = 1.1e-06， 即6个9的可靠性。</p>
<h4 id="2_附录">2 附录</h4><h4 id="2-1_估算代码">2.1 估算代码</h4><pre><code><span class="comment">#!/usr/bin/python</span>
<span class="comment"># -*- coding: utf-8 -*-</span>
<span class="keyword">import</span> decimal
<span class="keyword">import</span> math
<span class="keyword">import</span> time

<span class="comment"># 随机分布情况下系统的copyset组合数</span>
<span class="function"><span class="keyword">def</span> <span class="title">RandomCopySets</span><span class="params">(N, DiskSize, RepNum, Percent, PartSize)</span>:</span>
    setNum = (N * DiskSize * Percent / (RepNum *  PartSize))
    MaxCopySetNum = C(N, RepNum)

    copysetNum = <span class="number">0</span>
    <span class="keyword">if</span> setNum &gt; MaxCopySetNum:
        copysetNum = MaxCopySetNum
    <span class="keyword">else</span>:
        copysetNum =  setNum

    <span class="keyword">return</span> int(copysetNum)

<span class="comment"># N 个磁盘存储系统中T时间同时损坏K块盘的概率,年故障率ARF</span>
<span class="function"><span class="keyword">def</span>  <span class="title">KdiskFailRate</span><span class="params">(N, T, ARF, K)</span>:</span>
    <span class="comment"># λ 每小时的换盘数量</span>
    lambda1 = decimal.Decimal(str(N*AFR/<span class="number">24</span>/<span class="number">365</span>))
    <span class="keyword">return</span> poisson(lambda1, T, K)

<span class="comment"># 副本数R的N 个磁盘存储系统中T时间内造成数据丢失的概率, 只统计R -&gt; 2R-1个副本情况下的丢失数据概率(大于R个情况下，在一遍情况下对结果影响比较小)</span>
<span class="function"><span class="keyword">def</span> <span class="title">LossDataInT</span><span class="params">(S, N, RepNum, T, ARF)</span>:</span>
    loosRate = decimal.Decimal(str(<span class="number">0.0</span>))
    <span class="keyword">for</span> k <span class="keyword">in</span> range(RepNum, RepNum*<span class="number">2</span>):
        kdrate = KdiskFailRate(N,T,ARF,k)

        singlerate = S * C(N-<span class="number">3</span>, k-<span class="number">3</span>)/C(N,k)

        kdlossrate = kdrate * singlerate

        <span class="keyword">print</span> <span class="string">"k = "</span> + str(k)  + <span class="string">", "</span> +str(kdrate) + <span class="string">", "</span> + str(kdlossrate)

        loosRate += kdlossrate
    <span class="keyword">print</span> loosRate
    <span class="keyword">return</span> loosRate

<span class="comment"># define loseRate in one Year</span>
<span class="function"><span class="keyword">def</span> <span class="title">LoseRate</span><span class="params">(S, N, RepNum, T, AFR)</span>:</span>
    <span class="keyword">return</span> <span class="number">1</span> - (<span class="number">1</span> - LossDataInT(S, N, RepNum, T, AFR))**(<span class="number">365</span>*<span class="number">24</span>/T)

<span class="comment">#组合运算</span>
<span class="function"><span class="keyword">def</span> <span class="title">C</span><span class="params">(n, m)</span>:</span>
  <span class="keyword">return</span> factorial(n) / (factorial(m)*factorial(n-m))

<span class="comment">#泊松分布</span>
<span class="function"><span class="keyword">def</span> <span class="title">poisson</span><span class="params">(lam, t, R)</span>:</span>
    e=decimal.Decimal(str(math.e))
    <span class="keyword">return</span> ((lam * t) ** R) * (e**(-lam*t)) / factorial(R)

<span class="comment">#t时间内损坏R块磁盘的概率</span>
<span class="function"><span class="keyword">def</span> <span class="title">probability</span><span class="params">(t, R)</span>:</span>
  <span class="keyword">return</span> poisson(t, R)

<span class="comment">#级数</span>
<span class="function"><span class="keyword">def</span> <span class="title">factorial</span><span class="params">(n)</span>:</span>
  S = decimal.Decimal(<span class="string">"1"</span>)
  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, n+<span class="number">1</span>):
    N = decimal.Decimal(str(i))
    S = S*N
  <span class="keyword">return</span> S



<span class="comment"># case 1</span>
N = <span class="number">7200</span>
DiskSize = <span class="number">8</span>*<span class="number">1024</span>
Percent = <span class="number">0.7</span>
PartSize = <span class="number">10</span>
RepNum = <span class="number">3</span>
T = <span class="number">1</span>
AFR = <span class="number">0.04</span>

S  =  RandomCopySets(N, DiskSize, RepNum, Percent, PartSize)

<span class="keyword">print</span> LoseRate(S, N, RepNum, T, AFR)
</code></pre><h4 id="2-2_蒙特卡罗">2.2 蒙特卡罗</h4><p><a href="https://en.wikipedia.org/wiki/Monte_Carlo_method" target="_blank" rel="external">蒙特卡罗方法（Monte Carlo Method）</a>。是一种计算方法。原理是通过大量随机样本，去了解一个系统，进而得到所要计算的值。<br>它非常强大和灵活，又相当简单易懂，很容易实现。对于许多问题来说，它往往是最简单的计算方法，有时甚至是唯一可行的方法。 简单介绍可参见<a href="http://www.ruanyifeng.com/blog/2015/07/monte-carlo-method.html" target="_blank" rel="external">蒙特卡罗方法入门</a>。</p>
<p>在解这里的 X / C(7200, K) 的计算基本可以转换为不直接求X，而使用足够多的计算机随机试验来直接计算概率。 首先构建一个含S个随机的copyset<br>组合，然后从7200个节点中随机选择K个节点，记录每一次是否命中copyset，实验次数越多，概率越准确。</p>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/01/24/storage-durablity.html" class="next">分布式存储系统可靠性-如何估算<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'httpworkjlsungithubio';
var disqus_identifier = '/2017/02/18/storage-durablity-2.html';
var disqus_title = '分布式存储系统可靠性-系统估算示例';
var disqus_url = 'http://yoursite.com//2017/02/18/storage-durablity-2.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//httpworkjlsungithubio.disqus.com/count.js" async="async"></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div id="search"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">tech</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/存储/" style="font-size: 15px;">存储</a> <a href="/tags/S3/" style="font-size: 15px;">S3</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Tunning/" style="font-size: 15px;">Tunning</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/从优秀到卓越/" style="font-size: 15px;">从优秀到卓越</a> <a href="/tags/阅读/" style="font-size: 15px;">阅读</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/Pragraming-Languages/" style="font-size: 15px;">Pragraming Languages</a> <a href="/tags/HTTP-API/" style="font-size: 15px;">HTTP API</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Murphy-s-law/" style="font-size: 15px;">Murphy's law</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/浪漫/" style="font-size: 15px;">浪漫</a> <a href="/tags/古典/" style="font-size: 15px;">古典</a> <a href="/tags/云存储/" style="font-size: 15px;">云存储</a> <a href="/tags/CDN/" style="font-size: 15px;">CDN</a> <a href="/tags/交流/" style="font-size: 15px;">交流</a> <a href="/tags/云存储、cdn/" style="font-size: 15px;">云存储、cdn</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/performance/" style="font-size: 15px;">performance</a> <a href="/tags/goroutine/" style="font-size: 15px;">goroutine</a> <a href="/tags/storage/" style="font-size: 15px;">storage</a> <a href="/tags/consistency/" style="font-size: 15px;">consistency</a> <a href="/tags/avaliable/" style="font-size: 15px;">avaliable</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/02/18/storage-durablity-2.html">分布式存储系统可靠性-系统估算示例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/24/storage-durablity.html">分布式存储系统可靠性-如何估算</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/22/uploadsystem.html">网易云对象存储服务发布**“直传加速服务”**</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/splitDataWithSalt.html">Split Data With Salt</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/nos-from-0-1.html">“网易云存储服务”从0到1发展之路</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/DistributedSystem-Learning-Roadmap.html">Distributed System Learning Plan</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/MessageQueueInArch.html">构架中的消息队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/S3-HowTo-Dealwith-listObject.html">S3 HowTo Dealwith ListObject</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/tunning-nginx-performance.html">Nginx 性能调优</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/MyWifeMyLife.html">My Wife, My Life－七夕</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//httpworkjlsungithubio.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://andremouche.github.io/" title="Shirly-blog" target="_blank">Shirly-blog</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">Tom Talk.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></body><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>$(document).ready(function() {
  $('img').each(function() {
    if ($(this).parent().hasClass('fancybox')) return;
    if ($(this).hasClass('nofancybox')) return;
    var alt = this.alt;
    if (alt) $(this).after('<span class="caption">' + alt + '</span>');
    $(this).wrap('<a href="' + ($(this).attr('data-src') == null ? this.src : $(this).attr('data-src')) + '" title="' + alt + '" class="fancybox"></a>');
  });
  $(this).find('.fancybox').each(function(){
    $(this).attr('rel', 'article');
  });
});</script><script>$(document).ready(function() {
  $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
   helpers : {
   title: { type: 'inside'}
   }
 });
});
</script></html>