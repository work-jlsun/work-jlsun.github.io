<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="sunjianliang" />
    
    <title>Nginx And Go Http 并发性能</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="Tom 的Blog" type="application/atom+xml" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/media/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script type="text/javascript"> hljs.initHighlightingOnLoad(); </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="Tom 的Blog" class="" href="/">Tom 的Blog</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>Nginx And Go Http 并发性能 </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2014-01-20">2014-01-20</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#golang" title="golang">#golang</a>
    
    <a href="/tags.html#nginx" title="nginx">#nginx</a>
    
    <a href="/tags.html#performance" title="performance">#performance</a>
    
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span
    class           = "like-wrapper"
    like-shortname  = 'gopherwood'
    like-identifier = ''
    like-name       = 'Nginx And Go Http 并发性能'
    like-btn        = '&#xf087;'
    like-link       = 'http://tomsun.info/2014/01/20/golang-vs-nginx-test.html'
    ></span>
  <script type="text/javascript">
    var l = document.createElement('script');
    l.type = 'text/javascript'; l.async = true; l.src = 'http://www.like-btn.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <h2>1 测试硬件</h2>

<pre><code>Intel(R) Xeon(R) CPU           X3440  @ 2.53GHz
cpu cache size  : 8192 KB
DRAM：8G
</code></pre>

<h2>2 测试软件</h2>

<pre><code>2.6.32-5-amd64 #1 SMP
nginx：ngx_openresty-1.4.3.4 
go :go version go1.3.3 linux/amd64
ab：ApacheBench, Version 2.3 
</code></pre>

<h2>3 测试配置</h2>

<hr />

<h3>3.1  一些内核配置</h3>

<pre><code>/proc/sys/fs/file-max                    3145728
/proc/sys/fs/nr_open                     1048576
/proc/sys/net/core/netdev_max_backlog    1000
/proc/sys/net/core/rmem_max              131071
/proc/sys/net/core/wmem_max              131071
/proc/sys/net/core/somaxconn             128
/proc/sys/net/ipv4/ip_forward            0
/proc/sys/net/ipv4/ip_local_port_range   8192   65535
/proc/sys/net/ipv4/tcp_fin_timeout       60
/proc/sys/net/ipv4/tcp_keepalive_time    7200
/proc/sys/net/ipv4/tcp_max_syn_backlog   2048
/proc/sys/net/ipv4/tcp_max_tw_buckets    1048576
/proc/sys/net/ipv4/tcp_no_metrics_save   0
/proc/sys/net/ipv4/tcp_syn_retries       5
/proc/sys/net/ipv4/tcp_synack_retries    5
/proc/sys/net/ipv4/tcp_tw_recycle        0
/proc/sys/net/ipv4/tcp_tw_reuse          0
/proc/sys/vm/min_free_kbytes             11489
/proc/sys/vm/overcommit_memory           0
</code></pre>

<h3>3.2 Nginx</h3>

<pre><code>worker_processes  8;
events {
    worker_connections  2046;
    use epoll;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    location / {
            root   html;
            index  index.html index.htm;
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
            root   html;
    }
    location /ab-test {
            proxy_http_version 1.1;
            proxy_set_header Connection ""; 
            content_by_lua 'ngx.print("aaa---here omit other char a, total 512--- aaaaaa")';    
    }
}
</code></pre>

<h3>3.3 golang 测试代码</h3>

<p><a href="https://github.com/work-jlsun/golang/blob/develop/go512server.go">go512server.go</a></p>

<h2>4 测试方法</h2>

<h3>4.1 测试工具及命令</h3>

<p>使用 ab测试不同并发场景下nginx和golang http 服务的性能，测试数据大小512Byte。</p>

<p>测试命令示例：ab -n 1000000 -c 5000  -k  "http://127.0.0.1:8081/512b"</p>

<p>(ps: 所有测试结果，都是3次之后取平均值)</p>

<h3>4.2  测试结果</h3>

<ul>
<li>短连接场景</li>
</ul>


<table>
<thead>
<tr>
<th>并发请求量 </th>
<th> 100 </th>
<th> 200 </th>
<th> 500 </th>
<th> 1000 </th>
<th> 2000 </th>
<th> 5000</th>
</tr>
</thead>
<tbody>
<tr>
<td>nginx(tps) </td>
<td> 12741.62   </td>
<td> 12598.08     </td>
<td>  11917.15   </td>
<td>  12016.63 </td>
<td> 11640.36   </td>
<td>   6047.29</td>
</tr>
<tr>
<td>go（tps）  </td>
<td>  11310.32   </td>
<td> 11208.87     </td>
<td> 10731.40    </td>
<td>  10757.3  </td>
<td> 10750.26   </td>
<td>     10869.80</td>
</tr>
</tbody>
</table>


<p>ps： 端连接情况下 并发5000 情况下， nginx情况不知道是为什么（nginx进程cpu利用看起来不是很均衡）</p>

<ul>
<li>长连接场景</li>
</ul>


<table>
<thead>
<tr>
<th>并发请求量 </th>
<th> 100 </th>
<th> 200 </th>
<th> 500 </th>
<th> 1000 </th>
<th> 2000 </th>
<th> 5000</th>
</tr>
</thead>
<tbody>
<tr>
<td>nginx（tps）    </td>
<td>     61249.81   </td>
<td>     60672.71  </td>
<td>   59548.39  </td>
<td>   55287.55    </td>
<td>           58375.65    </td>
<td>     60662.44</td>
</tr>
<tr>
<td>go（tps）    </td>
<td>    55257.64       </td>
<td>     53288.23 </td>
<td>   49006.64  </td>
<td>  46362.55  </td>
<td>             48042.18      </td>
<td>    47855.02</td>
</tr>
</tbody>
</table>


<ul>
<li>golang + nginx （golang as proxy）</li>
</ul>


<table>
<thead>
<tr>
<th>并发请求量 </th>
<th> 100 </th>
<th> 200 </th>
<th> 500 </th>
<th> 1000 </th>
<th> 2000 </th>
<th> 5000</th>
</tr>
</thead>
<tbody>
<tr>
<td>go（tps）  </td>
<td>   31535.37   </td>
<td> 29081.96  </td>
<td>  30250.24  </td>
<td>   28921.48  </td>
<td>  26631.12  </td>
<td>    25333.64</td>
</tr>
</tbody>
</table>


<p>1: <a href="https://github.com/work-jlsun/golang/blob/develop/go512server.go">golang  proxy 代码</a></p>

<p>2: golang作为proxy的时候性能基本为非proxy的一半左右，这个是可以理解的，一个请求的响应时间就是nginx + go两层的响应时间。</p>

<p>3: 使用golang自带的httpclient连接后端的nginx</p>

<ul>
<li>nginx + golang （nginx as proxy）</li>
</ul>


<table>
<thead>
<tr>
<th>并发请求量 </th>
<th> 100 </th>
<th> 200 </th>
<th> 500 </th>
<th> 1000 </th>
<th> 2000 </th>
<th> 5000</th>
</tr>
</thead>
<tbody>
<tr>
<td>TPS </td>
<td> 43336.19    </td>
<td> 41722.05   </td>
<td> 37984.94  </td>
<td>  34033.42  </td>
<td>  29489.74  </td>
<td>         25693.03</td>
</tr>
</tbody>
</table>


<ul>
<li>golang proxy简单稳定性测试</li>
</ul>


<pre><code>5000 并发测试 30 分钟，tps 达到24751，基本没有因为随着时间的增长而对性能造成很大的影响，资源使用也比较稳定

1000并发测试 1小时 ， tsp达到 27651.10，基本没有因为随着时间的增长而对性能造成很大的影响，资源使用比较稳定
</code></pre>

<h2>5 测试结论</h2>

<p>基于以上4中场景，上百组测试下，得出一下简单结论</p>

<ul>
<li>golang表现还是较为出色，相比于标杆Nginx性能差20%左右</li>
<li>golang在高并发压力测试下稳定性还是不错，可以接受的</li>
</ul>


<p>当前我们基于简单测试环境下的测试验证golang，现实环境远远比测试环境复杂，后续我们会在NosMedia 开发测试上线过程中不断总结经验。</p>

<h2>6 参考资料</h2>

<ul>
<li><a href="https://gist.github.com/hgfischer/7965620">golang test</a></li>
<li><a href="http://blog.lifeibo.com/blog/2013/01/28/ngx-lua-and-go.html">nginx-lua vs golang</a></li>
</ul>


<h2>7 坑</h2>

<ol>
<li>goang http 长连接问题</li>
<li>Connection reset  by peer (104)</li>
</ol>


  </section>
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2014 ~ 2015 sunjianliang | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi">sext vi</a> | fork <a href="https://github.com/waynezhang/blog" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
